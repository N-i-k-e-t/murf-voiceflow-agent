# ğŸ“Š VoiceFlow Architecture & Design

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        VoiceFlow Voice Agent                           â”‚
â”‚                      (Production-Grade System)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“   â”‚
â”‚  â”ƒ           USER INTERFACE LAYER (CLI)                         â”ƒ   â”‚
â”‚  â”ƒ                                                               â”ƒ   â”‚
â”‚  â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”ƒ   â”‚
â”‚  â”ƒ  â”‚   Input: Voice  â”‚  â”‚  Output: Voice  â”‚                   â”ƒ   â”‚
â”‚  â”ƒ  â”‚   from Mic      â”‚  â”‚   to Speaker    â”‚                   â”ƒ   â”‚
â”‚  â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”ƒ   â”‚
â”‚  â”ƒ           â”‚                     â”‚                            â”ƒ   â”‚
â”‚  â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                    â”ƒ   â”‚
â”‚  â”ƒ  â”‚     cli_runner.py (Interface)        â”‚                   â”ƒ   â”‚
â”‚  â”ƒ  â”‚  - Record audio                      â”‚                   â”ƒ   â”‚
â”‚  â”ƒ  â”‚  - User prompts                      â”‚                   â”ƒ   â”‚
â”‚  â”ƒ  â”‚  - Playback audio                    â”‚                   â”ƒ   â”‚
â”‚  â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”ƒ   â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”¼â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›   â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“   â”‚
â”‚  â”ƒ        ORCHESTRATION LAYER (Agent)                          â”ƒ   â”‚
â”‚  â”ƒ                                                               â”ƒ   â”‚
â”‚  â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”ƒ   â”‚
â”‚  â”ƒ  â”‚        agent.py (VoiceAgent)                     â”‚       â”ƒ   â”‚
â”‚  â”ƒ  â”‚                                                  â”‚       â”ƒ   â”‚
â”‚  â”ƒ  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚       â”ƒ   â”‚
â”‚  â”ƒ  â”‚  â”‚    History   â”‚    â”‚  Reply Logic â”‚           â”‚       â”ƒ   â”‚
â”‚  â”ƒ  â”‚  â”‚ (Multi-turn) â”‚    â”‚  Inference   â”‚           â”‚       â”ƒ   â”‚
â”‚  â”ƒ  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚       â”ƒ   â”‚
â”‚  â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”ƒ   â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”¬â”â”â”â”â”›   â”‚
â”‚            â”‚                                              â”‚         â”‚
â”‚            â–¼                                              â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  SPEECH-TO-TEXT (ASR)    â”‚              â”‚ TEXT-TO-SPEECH (TTS) â”‚ â”‚
â”‚  â”‚                          â”‚              â”‚                      â”‚ â”‚
â”‚  â”‚ asr_deepgram.py          â”‚              â”‚ tts_murf.py          â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚  Deepgram API      â”‚   â”‚              â”‚ â”‚  Murf Falcon API â”‚ â”‚ â”‚
â”‚  â”‚ â”‚  - Nova-3 Model    â”‚   â”‚              â”‚ â”‚  - Streaming TTS â”‚ â”‚ â”‚
â”‚  â”‚ â”‚  - Smart Format    â”‚   â”‚              â”‚ â”‚  - 24kHz Audio   â”‚ â”‚ â”‚
â”‚  â”‚ â”‚  - Confidence      â”‚   â”‚              â”‚ â”‚  - Natural Voice â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â–²                                         â–²               â”‚
â”‚            â”‚                                         â”‚               â”‚
â”‚            â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚               â”‚
â”‚            â”‚                â”‚   LLM (OpenAI)   â”‚    â”‚               â”‚
â”‚            â”‚                â”‚                  â”‚    â”‚               â”‚
â”‚            â”‚                â”‚ llm_openai.py    â”‚    â”‚               â”‚
â”‚            â”‚                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚               â”‚
â”‚            â”‚                â”‚ â”‚ GPT-4o-mini  â”‚ â”‚    â”‚               â”‚
â”‚            â”‚                â”‚ â”‚ Context Chat â”‚ â”‚    â”‚               â”‚
â”‚            â”‚                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚               â”‚
â”‚            â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚               â”‚
â”‚            â”‚                       â–²                â”‚               â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“  â”‚
â”‚  â”ƒ    INFRASTRUCTURE LAYER                                   â”ƒ  â”‚
â”‚  â”ƒ                                                             â”ƒ  â”‚
â”‚  â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ  â”‚
â”‚  â”ƒ  â”‚  config.py   â”‚  â”‚  logger.py   â”‚  â”‚  utils/         â”‚  â”ƒ  â”‚
â”‚  â”ƒ  â”‚              â”‚  â”‚              â”‚  â”‚  - exceptions   â”‚  â”ƒ  â”‚
â”‚  â”ƒ  â”‚ Validation   â”‚  â”‚ Logging      â”‚  â”‚  - retry        â”‚  â”ƒ  â”‚
â”‚  â”ƒ  â”‚ Config vars  â”‚  â”‚ File + cons  â”‚  â”‚  - audio        â”‚  â”ƒ  â”‚
â”‚  â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ  â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

```
USER INPUT (VOICE)
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. RECORD AUDIO                                          â”‚
â”‚  â”œâ”€ PyAudio captures from microphone                      â”‚
â”‚  â”œâ”€ 16kHz, mono, 16-bit PCM                               â”‚
â”‚  â”œâ”€ Auto-stop on 2s silence                               â”‚
â”‚  â””â”€ Saved as WAV bytes                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼ (WAV bytes)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. SPEECH-TO-TEXT (ASR)                                  â”‚
â”‚  â”œâ”€ Send to Deepgram API                                  â”‚
â”‚  â”œâ”€ Model: Nova-3                                         â”‚
â”‚  â”œâ”€ Smart formatting enabled                              â”‚
â”‚  â”œâ”€ Retry logic on failure                                â”‚
â”‚  â””â”€ Returns: Text transcript                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼ (Text transcript)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. LANGUAGE MODEL (LLM)                                  â”‚
â”‚  â”œâ”€ Send to OpenAI API                                    â”‚
â”‚  â”œâ”€ Model: gpt-4o-mini                                    â”‚
â”‚  â”œâ”€ System prompt: VoiceFlow assistant role               â”‚
â”‚  â”œâ”€ Maintain conversation history                         â”‚
â”‚  â”œâ”€ Retry logic on failure                                â”‚
â”‚  â””â”€ Returns: AI response text                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼ (Response text)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. TEXT-TO-SPEECH (TTS)                                  â”‚
â”‚  â”œâ”€ Send to Murf Falcon API                               â”‚
â”‚  â”œâ”€ Voice: Matthew (or configured)                        â”‚
â”‚  â”œâ”€ Streaming: Real-time audio chunks                     â”‚
â”‚  â”œâ”€ Format: PCM 24kHz                                     â”‚
â”‚  â”œâ”€ Retry logic on failure                                â”‚
â”‚  â””â”€ Returns: Audio stream iterator                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼ (Audio chunks)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. PLAYBACK AUDIO                                        â”‚
â”‚  â”œâ”€ PyAudio outputs to speaker                            â”‚
â”‚  â”œâ”€ Streams chunks in real-time                           â”‚
â”‚  â”œâ”€ 24kHz, mono, 16-bit PCM                               â”‚
â”‚  â””â”€ User hears response                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
USER OUTPUT (VOICE)
```

---

## Component Interaction

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              VoiceFlow Components                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  cli_runner.py (User Interface)              â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
    â”‚  â€¢ record_audio()  â†â†’  PyAudio               â”‚
    â”‚  â€¢ play_audio_stream() â†â†’  PyAudio           â”‚
    â”‚  â€¢ main() orchestrates flow                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                               â”‚
           â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ asr_deepgram.py â”‚           â”‚ tts_murf.py     â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚           â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚ â€¢ Deepgram API  â”‚           â”‚ â€¢ Murf API      â”‚
    â”‚ â€¢ Transcribe    â”‚           â”‚ â€¢ Stream TTS    â”‚
    â”‚ â€¢ Retry logic   â”‚           â”‚ â€¢ Retry logic   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                             â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   agent.py           â”‚
              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
              â”‚ â€¢ VoiceAgent class   â”‚
              â”‚ â€¢ Conversation hist  â”‚
              â”‚ â€¢ Reply logic        â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  llm_openai.py       â”‚
              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
              â”‚ â€¢ OpenAI API         â”‚
              â”‚ â€¢ GPT-4o-mini        â”‚
              â”‚ â€¢ Chat completion    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Support Systems                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  config.py                logger.py                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
â”‚  â€¢ Load env vars          â€¢ File logging                â”‚
â”‚  â€¢ Validate config        â€¢ Console logging             â”‚
â”‚  â€¢ Defaults               â€¢ Debug mode                  â”‚
â”‚                                                          â”‚
â”‚  utils/exceptions.py      utils/retry.py   utils/audio.py
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚  â€¢ Custom errors          â€¢ Retry decoratorâ€¢ Audio utils
â”‚  â€¢ Error handling         â€¢ Backoff logic  â€¢ Audio tools
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Sequence Diagram (One Complete Cycle)

```
User        cli_runner       ASR         LLM         TTS         Speaker
  â”‚              â”‚            â”‚           â”‚           â”‚             â”‚
  â”‚â”€â”€"Press  â†’   â”‚            â”‚           â”‚           â”‚             â”‚
  â”‚  Enter"      â”‚            â”‚           â”‚           â”‚             â”‚
  â”‚              â”‚            â”‚           â”‚           â”‚             â”‚
  â”‚  Speaks      â”‚            â”‚           â”‚           â”‚             â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’    â”‚            â”‚           â”‚           â”‚             â”‚
  â”‚              â”‚            â”‚           â”‚           â”‚             â”‚
  â”‚            record_audio() â”‚           â”‚           â”‚             â”‚
  â”‚              â”‚â—„â”€â”€[WAV]â”€â”€â”€â”€â”¤           â”‚           â”‚             â”‚
  â”‚              â”‚            â”‚           â”‚           â”‚             â”‚
  â”‚              â”‚ transcribe_wav()        â”‚           â”‚             â”‚
  â”‚              â”œâ”€â”€â”€[WAV]â”€â”€â”€â†’â”‚           â”‚           â”‚             â”‚
  â”‚              â”‚            â”‚           â”‚           â”‚             â”‚
  â”‚              â”‚â—„â”€â”€[TEXT]â”€â”€â”€â”¤           â”‚           â”‚             â”‚
  â”‚              â”‚            â”‚           â”‚           â”‚             â”‚
  â”‚              â”‚         agent.reply()  â”‚           â”‚             â”‚
  â”‚              â”‚â”€â”€â”€â”€[TEXT]â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚           â”‚             â”‚
  â”‚              â”‚                     â”‚             â”‚             â”‚
  â”‚              â”‚         llm.chat()  â”‚             â”‚             â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’    â”‚             â”‚             â”‚
  â”‚              â”‚                     â”‚             â”‚             â”‚
  â”‚              â”‚         [RESPONSE]  â”‚             â”‚             â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚             â”‚
  â”‚              â”‚                                  â”‚             â”‚
  â”‚              â”‚         tts.stream_tts()         â”‚             â”‚
  â”‚              â”œâ”€â”€â”€â”€â”€[RESPONSE TEXT]â”€â†’             â”‚             â”‚
  â”‚              â”‚                    â”‚             â”‚             â”‚
  â”‚              â”‚                  [AUDIO CHUNKS]â”€â”€â†’             â”‚
  â”‚              â”‚                                  â”‚             â”‚
  â”‚              â”‚ play_audio_stream()              â”‚             â”‚
  â”‚              â”œâ”€â”€[AUDIO CHUNKS]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’           â”‚
  â”‚              â”‚                                  â”‚             â”‚
  â”‚ Hears    â—„â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Response â”‚                                                    â”‚
  â”‚          â”‚                                                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Module Dependencies

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    app/cli_runner.py                    â”‚
â”‚                  (Main Entry Point)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  app/agent  â”‚            â”‚  utils/audio    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚  app/llm_openai       â”‚   â”‚  PyAudio    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  app/asr_deepgram       â”‚
    â”‚  app/tts_murf           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Core Dependencies:
â”œâ”€â”€ requests (HTTP client for APIs)
â”œâ”€â”€ openai (OpenAI client)
â”œâ”€â”€ murf (Murf Falcon client)
â”œâ”€â”€ pyaudio (Audio I/O)
â”œâ”€â”€ python-dotenv (Environment variables)
â”œâ”€â”€ colorama (Terminal colors)
â”‚
â””â”€â”€ Internal:
    â”œâ”€â”€ config (Configuration)
    â”œâ”€â”€ logger (Logging)
    â”œâ”€â”€ utils/exceptions (Error handling)
    â”œâ”€â”€ utils/retry (Retry logic)
    â””â”€â”€ utils/audio (Audio utilities)
```

---

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Call / Operation                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  Success?  â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”˜
           â”‚   â”‚
         Yesâ”‚  Noâ”‚
           â”‚    â”‚
           â”‚    â–¼
           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ â”‚  Retry (if <max) â”‚
           â”‚ â”‚  Backoff delay   â”‚
           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚          â”‚
           â”‚          â–¼
           â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚      â”‚ Max retries?
           â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”˜
           â”‚           â”‚   â”‚
           â”‚         Noâ”‚   Yesâ”‚
           â”‚           â”‚     â”‚
           â”‚           â””â”€â”€â”¬â”€â”€â–¼
           â”‚              â”‚
           â–¼â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Return Resultâ”‚
      â”‚ or Exception â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  Caught by     â”‚
      â”‚  try/except    â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
           â”‚      â”‚
           â”‚      â””â”€â†’ Log Error
           â”‚          Notify User
           â”‚          Continue Flow
           â”‚
           â–¼
      Return/Continue
```

---

## Configuration Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Configuration Sources (Priority Order)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  1. System Environment Variables (Highest) â”‚
â”‚     â”œâ”€ MURF_API_KEY=xxx                    â”‚
â”‚     â”œâ”€ DEEPGRAM_API_KEY=xxx                â”‚
â”‚     â””â”€ OPENAI_API_KEY=xxx                  â”‚
â”‚                                             â”‚
â”‚  2. .env File                              â”‚
â”‚     â”œâ”€ MURF_REGION=GLOBAL                  â”‚
â”‚     â”œâ”€ MURF_VOICE_ID=Matthew               â”‚
â”‚     â””â”€ LOG_LEVEL=INFO                      â”‚
â”‚                                             â”‚
â”‚  3. config.py Defaults (Lowest)            â”‚
â”‚     â”œâ”€ SAMPLE_RATE=16000                   â”‚
â”‚     â”œâ”€ RECORD_SECONDS=10                   â”‚
â”‚     â””â”€ MAX_RETRIES=3                       â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  app/config.py  â”‚
    â”‚  (Consolidated) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  All modules access   â”‚
    â”‚  via config imports   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Testing Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Test Suite Structure             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  conftest.py                                â”‚
â”‚  â”œâ”€ Pytest configuration                    â”‚
â”‚  â””â”€ Shared fixtures                         â”‚
â”‚                                              â”‚
â”‚  test_config.py                             â”‚
â”‚  â”œâ”€ Configuration loading                   â”‚
â”‚  â”œâ”€ Environment variable handling           â”‚
â”‚  â””â”€ Validation logic                        â”‚
â”‚                                              â”‚
â”‚  test_asr.py                                â”‚
â”‚  â”œâ”€ DeepgramASRClient initialization        â”‚
â”‚  â”œâ”€ Transcription logic                     â”‚
â”‚  â””â”€ Error handling                          â”‚
â”‚                                              â”‚
â”‚  test_tts.py                                â”‚
â”‚  â”œâ”€ MurfTTSClient initialization            â”‚
â”‚  â”œâ”€ Streaming logic                         â”‚
â”‚  â””â”€ Error handling                          â”‚
â”‚                                              â”‚
â”‚  test_llm.py                                â”‚
â”‚  â”œâ”€ LLMClient initialization                â”‚
â”‚  â”œâ”€ Chat logic                              â”‚
â”‚  â””â”€ Error handling                          â”‚
â”‚                                              â”‚
â”‚  test_agent.py                              â”‚
â”‚  â”œâ”€ VoiceAgent initialization               â”‚
â”‚  â”œâ”€ Reply generation                        â”‚
â”‚  â””â”€ History maintenance                     â”‚
â”‚                                              â”‚
â”‚  test_integration.py                        â”‚
â”‚  â””â”€ End-to-end flow testing                 â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  pytest execution  â”‚
   â”‚  â€¢ Mock external   â”‚
   â”‚  â€¢ Isolated tests  â”‚
   â”‚  â€¢ Coverage report â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deployment Architecture

```
Development Environment
â”œâ”€ .env file
â”œâ”€ requirements.txt
â””â”€ Python venv

     â”‚
     â–¼ (pip install)

Testing Environment
â”œâ”€ requirements-dev.txt
â”œâ”€ pytest
â””â”€ Code coverage tools

     â”‚
     â–¼ (tests pass)

Production Deployment
â”œâ”€ Docker Image
â”‚  â”œâ”€ Base: Python 3.11-slim
â”‚  â”œâ”€ Dependencies installed
â”‚  â”œâ”€ Code copied
â”‚  â””â”€ Entry point: cli_runner
â”‚
â”œâ”€ Server/Cloud Deployment
â”‚  â”œâ”€ Set environment variables
â”‚  â”œâ”€ Run container
â”‚  â””â”€ Stream logs
â”‚
â””â”€ Local Deployment
   â”œâ”€ .env configured
   â”œâ”€ python -m app.cli_runner
   â””â”€ Interactive voice session
```

---

This document provides complete visual representation of VoiceFlow's architecture!
